@page "/iniciar-sesion"
@inject IBlogService blogService
@inject LoginValidator loginValidator
@inject LoaderService loaderService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

@using Microsoft.AspNetCore.Components.Authorization
@using simple_crud.Client.Infrastructure
@using simple_crud.Client.Validator.User
@using simple_crud.Library.Models.DTOs

<h3>Iniciar sesión</h3>

<form onsubmit="@OnSubmit">

    <div class="form-input">
        <label for="username">Nombre de usuario</label>
        <input type="text" id="username" @bind="Model.Username" />
        @if (ValidationErrors.ContainsKey(nameof(Model.Username)))
        {
            <p class="input-error">@ValidationErrors[nameof(Model.Username)]</p>
        }
    </div>

    <div class="form-input">

        <label for="password">Contraseña</label>
        <input type="password" id="password" @bind="Model.Password" />
        @if (ValidationErrors.ContainsKey(nameof(Model.Password)))
        {
            <p class="input-error">@ValidationErrors[nameof(Model.Password)]</p>
        }
    </div>

    <input type="submit" value="Confirmar" />
</form>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <p style="color:red">@ErrorMessage</p>
}

@code {
    private LoginViewModel Model { get; set; } = new();
    private Dictionary<string, string> ValidationErrors { get; set; } = new();
    private string ErrorMessage { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private async Task OnSubmit()
    {
        ErrorMessage = string.Empty;
        ValidationErrors.Clear();

        var validationResult = await loginValidator.ValidateAsync(Model);

        if (!validationResult.IsValid)
        {
            foreach (var error in validationResult.Errors)
            {
                // Guardamos el primer error por propiedad
                if (!ValidationErrors.ContainsKey(error.PropertyName))
                    ValidationErrors[error.PropertyName] = error.ErrorMessage;
            }
            return; // detenemos aquí si hay errores
        }

        try
        {
            loaderService.Show();

            var dto = new LoginUsuarioDTO
            {
                Username = Model.Username!,
                Password = Model.Password!
            };

            var operationLogin = await blogService.LoginAsync(dto);

            if (!operationLogin.Success)
            {
                ErrorMessage = operationLogin.Message!;
                return;
            }

            ((JwtAuthStateProvider)AuthStateProvider).NotifyUserAuthentication();
            NavigationManager.NavigateTo("/");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Ocurrió un error inesperado: {ex.Message}";
        }
        finally
        {
            loaderService.Hide();
        }
    }
}
